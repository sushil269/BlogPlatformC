{% extends 'base.html' %}
{% block content %}

<div class="container mt-4">

    <!-- Post content -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h2 class="fw-bold">{{ post.title }}</h2>
            
            <small class="text-muted">
                {{ post.publication_date }}
            </small>

            <p class="mt-3">{{ post.content }}</p>
        </div>
    </div>

    <!-- comment title -->
    <h4 class="fw-bold">Comments</h4>

    <!-- ADD NEW TOP-LEVEL COMMENT -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <form method="POST">
                {% csrf_token %}
                <textarea name="comment" class="form-control" rows="3"
                          placeholder="Write a comment..." required></textarea>
                <button class="btn btn-primary mt-2">Post Comment</button>
            </form>
        </div>
    </div>

    <!-- SHOW TOP LEVEL COMMENTS -->
    {% for c in comments %}
    <div class="card mb-3 shadow-sm">
        <div class="card-body">

            <strong>{{ c.author.username }}</strong>
            <small class="text-muted"> • {{ c.created_date }}</small>

            <p class="mt-2">{{ c.content }}</p>

            <!-- Reply Button (GRAY) -->
            <button class="btn btn-secondary btn-sm"
                    type="button"
                    onclick="toggleReplyForm({{ c.id }})">
                Reply
            </button>

            <!--  Reply Form -->
            <div id="reply-form-{{ c.id }}" class="mt-2" style="display:none;">
                <form method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="parent_id" value="{{ c.id }}">
                    <textarea name="comment" class="form-control" rows="2"
                              placeholder="Write a reply..."></textarea>
                    <button class="btn btn-primary btn-sm mt-2">Post Reply</button>
                </form>
            </div>

            <!-- Replies to this comment -->
            {% for reply in c.replies.all %}
            <div class="ms-4 mt-3 p-2 border-start">

                <strong>{{ reply.author.username }}</strong>
                <small class="text-muted"> • {{ reply.created_date }}</small>

                <p class="mt-2">{{ reply.content }}</p>

                <!-- Reply to reply (GRAY) -->
                <button class="btn btn-secondary btn-sm"
                        type="button"
                        onclick="toggleReplyForm({{ reply.id }})">
                    Reply
                </button>

                <!-- Reply form for replying to replies -->
                <div id="reply-form-{{ reply.id }}" class="mt-2" style="display:none;">
                    <form method="POST">
                        {% csrf_token %}
                        <input type="hidden" name="parent_id" value="{{ reply.id }}">
                        <textarea name="comment" class="form-control" rows="2"
                                  placeholder="Write a reply..."></textarea>
                        <button class="btn btn-primary btn-sm mt-2">Post Reply</button>
                    </form>
                </div>

                <!--Edit/Delete buttons for replies
                    only the comment owner see these button 
                -->
                {% if user == reply.author %}
                <a class="btn btn-sm btn-warning" href="{% url 'comment_edit' reply.id %}">Edit</a>
                <a class="btn btn-sm btn-danger"
                   href="{% url 'comment_delete' reply.id %}"
                   onclick="return confirm('Delete this reply?');">
                    Delete
                </a>
                {% endif %}

            </div>
            {% endfor %}

            <!-- Edit/Delete buttons for main comments -->
            {% if user == c.author %}
            <a class="btn btn-sm btn-warning" href="{% url 'comment_edit' c.id %}">Edit</a>
            <a class="btn btn-sm btn-danger"
               href="{% url 'comment_delete' c.id %}"
               onclick="return confirm('Delete this comment?');">
                Delete
            </a>
            {% endif %}

        </div>
    </div>
    {% empty %}
        <p>No comments yet.</p>
    {% endfor %}

    <!-- Pagination -->
    <nav>
        <ul class="pagination justify-content-center">

            {% if comments.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?cpage={{ comments.previous_page_number }}">
                    Previous
                </a>
            </li>
            {% endif %}

            <li class="page-item disabled">
                <a class="page-link">
                    Comments Page {{ comments.number }} of {{ comments.paginator.num_pages }}
                </a>
            </li>

            {% if comments.has_next %}
            <li class="page-item">
                <a class="page-link" href="?cpage={{ comments.next_page_number }}">
                    Next
                </a>
            </li>
            {% endif %}

        </ul>
    </nav>

</div>

<!-- Reply Form Toggle Script -->
<script>
function toggleReplyForm(id) {
    let box = document.getElementById("reply-form-" + id);
    if (!box) return;
    box.style.display =
        (box.style.display === "none" || box.style.display === "") ? "block" : "none";
}
</script>

{% endblock %}